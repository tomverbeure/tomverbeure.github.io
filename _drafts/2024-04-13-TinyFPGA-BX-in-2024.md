---
layout: post
title: TinyFPGA BX in 2024
date:   2024-04-13 00:00:00 -1000
categories:
---

* TOC
{:toc}

# Introduction

4 years ago, I bought a bunch of TinyFPGA-BX boards for a project but in the end I didn't
need them. They've been sitting unused in my box-with-FPGA-boards ever since.

I'm occasionally post on the FPGA subreddit, and somebody contacted my yesterday about 
issues with getting TinyFPGA-BX to work. Eventually they were able to make it work the
hard way, by soldering some wires straigth to the SPI flash and driving it with an Arduino.

That seemed a little bit over the top, so I decided to have a look about what's going on.

# Should you buy a TinyFPGA-BX Today?

Let's get the most important question out of the way, the answer is:

**No.**

# What is TinyFPGA-BX?

TinyFPGA-BX is the last in a family of, well, tiny FPGA development boards. It was introduced
sometime in 2018, quite cheap, and it was riding the wave of Project IceStorm, the Lattice iCE40
FPGA reverse-engineering project that made an end-to-end open source FPGA development flow 
possible.

TinyFPGA-BX must be one of the most popular FPGA development boards ever. Last year, I still
saw them for sale in Tokyo's Akihabara district.

One peculiar characteristic of the TinyFPGA-BX board is that it doesn't have an external
USB chip to program the SPI flash of the FPGA. Instead, the SPI flash contains multiple
bitstream: a bootloader that implements a USB FS device on the FPGA, and a user bitstream
for your own personal hardware.

When you power on the TinyFPGA by plugging in a USB cable, it first acts as a USB device, but
if it doesn't detect a special USB activity after a few seconds, it reboots to the user bitstream...
under certain circumstances at least. We'll get into that.

The TinyFPGA-BX board is light on other peripherals: your bitstream can control an LED and that's
about it. Everything else must be provided by the user.

The original creator of TinyFPGA-BX has left the project many years ago, but you can still
[pre-order them on CrowdSupply](https://www.crowdsupply.com/tinyfpga/tinyfpga-ax-bx#products), 
available May 31, 2024, or on [Mouser](https://www.mouser.com/ProductDetail/Crowd-Supply/CS-TINYFPGA-01?qs=0lSvoLzn4L9U5DUEM7Xg6A%3D%3D).

# Plugging in the device

I'm using Ubuntu 22.04. When you plug in the device, you should see something like this:

```sh
sudo dmesg -w
```

```
[10306.928342] usb 1-9.2: new full-speed USB device number 58 using xhci_hcd
[10307.230669] usb 1-9.2: New USB device found, idVendor=1209, idProduct=2100, bcdDevice= 0.00
[10307.230677] usb 1-9.2: New USB device strings: Mfr=0, Product=0, SerialNumber=0
[10307.253021] cdc_acm 1-9.2:1.0: ttyACM0: USB ACM device
```

The last line tells us that it's pretending to be USB device of the communication device
class (CDC) that's using the abstract control model (ACM) sub-class. This is often
used for serial devices such are UARTs. The important part here is that Windows and Linux
support these kind of devices by default. You don't need any special drivers for it. It's
also a relatively low complexity device, which is important if you want to create a pure
hardware implementation as is the case here.

Of note are the USB vendor and product ID of "1209:2100". We'll later see that this means trouble.

# tinyfpga.com website is dead

The CrowdSupply webpage still points to [tinyfpga.com](https://tinyfpga.com).

![tinyfpga.com link](/assets/tinyfpga/tinyfpga_com_link.png)

Unfortunately, that link is dead. This means more trouble.

# Installing Apio

In [their own words]...

> Apio is a multiplatform toolbox with static pre-built packages to verify, synthesize, simulate 
> and upload your verilog designs into the supported FPGA boards

I hadn't used it before, chances are high that a beginner will use that to get TinyFPGA-BX up
and running.

Installation was easy.

First install the core `apio` tool as a Python package:

```sh
pip3 install apio
```

In my case, I had to update my `$PATH` to include a location `./bin` directory:
```sh
PATH="/home/tom/.local/bin:$PATH"
```

Install a bunch of apio sub-packages:

```sh
apio install -a
```

Install a driver for the USB serial port:
```sh
apio drivers --serial-enable
```

You'll see something like this after the last command:
```
Configure Serial drivers for FPGA
Serial drivers enabled
Unplug and reconnect your board
Restart your machine to enable the dialout group
```

Before rebooting, I also ran the following:

```sh
sudo usermod -a -G dialout $USER
exec su -l $USER
```

# Tinyprog

The TinyFPGA-BX bootloaders has a companion tool, `tinyprog`, to communicate between
the PC and the bootloader. It can ask for status information, program a new bitstream
and so forth.

It's also a Python program so let's install that:

```sh
sudo pip3 install tinyprog
```

If all goes well, you can now ask tinyprog to interact with your board. It's
also where things started to go wrong.

# device reports readiness to read but returned no data

You can use `tinyprog -l` to list all the connected and active FPGA boards. When I ran this,
I got the following:

```
    TinyProg CLI
    ------------
    Using device id 1d50:6130
    Only one board with active bootloader, using it.
    Boards with active bootloaders:
Traceback (most recent call last):
...
    raise SerialException(
serial.serialutil.SerialException: device reports readiness to read but returned no data (device disconnected or multiple access on port?)
```


When doring `tinyprog --update-bootloader`:

```
[  119.684746] usb 1-9: USB disconnect, device number 14
[  119.982629] usb 1-9: new full-speed USB device number 15 using xhci_hcd
[  120.138668] usb 1-9: device descriptor read/64, error -71
[  120.374954] usb 1-9: device descriptor read/64, error -71
[  120.614905] usb 1-9: new full-speed USB device number 16 using xhci_hcd
[  120.771385] usb 1-9: device descriptor read/64, error -71
[  121.006967] usb 1-9: device descriptor read/64, error -71
[  121.119142] usb usb1-port9: attempt power cycle
[  121.530935] usb 1-9: new full-speed USB device number 17 using xhci_hcd
[  121.557952] usb 1-9: Device not responding to setup address.
[  121.793961] usb 1-9: Device not responding to setup address.
[  122.002958] usb 1-9: device not accepting address 17, error -71
[  122.134951] usb 1-9: new full-speed USB device number 18 using xhci_hcd
[  122.161974] usb 1-9: Device not responding to setup address.
[  122.397730] usb 1-9: Device not responding to setup address.
[  122.606951] usb 1-9: device not accepting address 18, error -71
[  122.610813] usb usb1-port9: unable to enumerate USB device
[  124.022754] usb 1-9: new full-speed USB device number 19 using xhci_hcd
[  124.342997] usb 1-9: New USB device found, idVendor=1209, idProduct=2100, bcdDevice= 0.00
[  124.343004] usb 1-9: New USB device strings: Mfr=0, Product=0, SerialNumber=0
[  124.369574] cdc_acm 1-9:1.0: ttyACM0: USB ACM device
```

Issue resolve when putting a USB hub in between!

```
tinyprog --update-bootloader
```

```
    TinyProg CLI
    ------------
    Using device id 1d50:6130
    Only one board with active bootloader, using it.
Traceback (most recent call last):
  File "/home/tom/.local/bin/tinyprog", line 8, in <module>
    sys.exit(main())
  File "/home/tom/.local/lib/python3.10/site-packages/tinyprog/__main__.py", line 314, in main
    perform_bootloader_update(port)
  File "/home/tom/.local/lib/python3.10/site-packages/tinyprog/__main__.py", line 128, in perform_bootloader_update
    bootloader_update_info = json.loads(urlopen(m[u"bootmeta"][u"update"] + "/bootloader.json").read())
  File "/usr/lib/python3.10/urllib/request.py", line 216, in urlopen
    return opener.open(url, data, timeout)
  File "/usr/lib/python3.10/urllib/request.py", line 525, in open
    response = meth(req, response)
  File "/usr/lib/python3.10/urllib/request.py", line 634, in http_response
h   response = self.parent.error(
  File "/usr/lib/python3.10/urllib/request.py", line 563, in error
    return self._call_chain(*args)
  File "/usr/lib/python3.10/urllib/request.py", line 496, in _call_chain
    result = func(*args)
  File "/usr/lib/python3.10/urllib/request.py", line 643, in http_error_default
    raise HTTPError(req.full_url, code, msg, hdrs, fp)
urllib.error.HTTPError: HTTP Error 403: Forbidden
```

The SPI flash of TinyFPGA-BX itself contains the expired tinyfpga.com URL:
https://github.com/tinyfpga/TinyFPGA-Bootloader?tab=readme-ov-file#spi-flash-memory-address-0xff000

```sh
tinyprog -m
```

```
[
  {
    "boardmeta": {
      "name": "TinyFPGA BX",
      "fpga": "ice40lp8k-cm81",
      "hver": "1.0.0",
      "uuid": "dd6830d1-2a5a-4fb9-9b14-8c5b939228c8"
    },
    "bootmeta": {
      "bootloader": "TinyFPGA USB Bootloader",
      "bver": "1.0.1",
      "update": "https://tinyfpga.com/update/tinyfpga-bx",
      "addrmap": {
        "bootloader": "0x000a0-0x28000",
        "userimage": "0x28000-0x50000",
        "userdata": "0x50000-0x100000"
      }
    },
    "port": "/dev/ttyACM0"
  }
]
```

```
apio build
```

```
[Sat Apr 13 10:59:46 2024] Processing TinyFPGA-BX
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
yosys -p "synth_ice40 -top Test -json hardware.json" -q Blinky.v
nextpnr-ice40 --lp8k --package cm81 --json hardware.json --asc hardware.asc --pcf TinyFPGA-BX-pins.pcf -q
icepack hardware.asc hardware.bin
═══════════════════════════════════════════════════════════════════════ [SUCCESS] Took 0.71 seconds ═══════════════════════════════════════════════════════════════════════
```

# Plugging it in

```
sudo dmesg
```

```
[477848.709607] usb 1-9: new full-speed USB device number 13 using xhci_hcd
[477849.026823] usb 1-9: New USB device found, idVendor=1209, idProduct=2100, bcdDevice= 0.00
[477849.026828] usb 1-9: New USB device strings: Mfr=0, Product=0, SerialNumber=0
[477849.050580] cdc_acm 1-9:1.0: ttyACM0: USB ACM device
```

# Issues

* [3v3 pin is 5v on a BX from Crowd Supply](https://github.com/tinyfpga/TinyFPGA-BX/issues/39)

    I didn't see this issue...

* [Host semi-recognizes (but not enough) bootloader USB device](https://github.com/tinyfpga/TinyFPGA-Bootloader/issues/74)

    Issue solved by using a USB hub.

* [Can't program new TinyFPGA BX ~ 2023-08-22, possibly no metadata?](https://github.com/tinyfpga/TinyFPGA-BX/issues/37)

    I didn't see this issue. Solution is to patch tinyprog with hard-coded meta-data.

* tinyfpga.com URL is expired.

    Because of this, you can't do `tinyprog --update-bootloader`.
    It's trying to fetch: https://tinyfpga.com/update/tinyfpga-bx/bootloader.json

* `apio upload` doesn't work

    It's looking for vid/pid 1d50:6130 (as in /home/tom/.local/lib/python3.10/site-packages/apio/resources/boards.json), but
    my board still has vid/pid 1209:2100 of TinyFPGA-B2.
    When I patch that, 'apio upload' works.

    See `check_for_wrong_tinyfpga_bx_vidpid()` in `tinyprog/__main__.py`

