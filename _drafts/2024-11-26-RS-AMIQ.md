---
layout: post
title: Rohde & Schwarz AMIQ Repair 
date:   2024-11-26 00:00:00 -1000
categories:
---

* TOC
{:toc}

# Introduction

Every few months, a local company auctions off all kinds of lab, production and test equipment. 
I shouldn't be subscribed to their email list but I am, and that another way to end up with more
stuff that I don't really need.

During a recent auction, I got my hands on a Rohde & Schwarz AMIQ, an I/Q modulation
generator, for a grand total of $45. Add to that another 30% for the auction fee and taxes and
you're still paying much less than what others would pay for a round of golf? But instead of 
one morning, this thing has the potential to keep me busy for many weekends, so what a deal! 

A few days after "winning" the auction, I drove to a dark dungeon of a warehouse in San Jose
to pick up the loot.

The AMIQ has a power on/off button power button and 3 LEDs and that's in terms of user interface.
There are no dials and there's no display. So without any other options, I simply powered it up
and I was immediately greeted by the ominous clicking of a spinning disk hard drive. I was right: 
this thing would keep me entertained for at least little bit!

[![AMIQ backside view](/assets/amiq/amiq_backside.jpg)](/assets/amiq/amiq_backside.jpg)
*(Click to enlarge)*

As I write this, I don't have the AMIQ fully up and running, and I'm not sure if I'll ever
be able to restore it a full working state, but I've made good progress and some of the
things I've learned might be useful to others.

In this blog post, I'll discuss the functionality of the R&S AMIQ and go through the steps of
reviving the PC that is enclosed in the machine.

# The Rohde & Schwarz AMIQ Modulation Generator

Reduced to an elevator sales pitch, the AMIQ can be described as *a sample streaming buffer that 
is connected to a 2 DAC that can run at a rate of up to 105MHz*. Or even more succinct: it's
*a 2-channel arbitrary waveform generator (AWG) with a deep sample buffer*. That's it!

The I and Q output channels of the AMIQ will typically contain quadrature modulation signals
that gets sent to a vector signal generator such as a Rohde & Schwarz SMIQ for the actual
high-frequency modulation. In a typical setup, the AMIQ is used to generate the baseband 
modulated signal and the SMIQ shifts that baseband signal to an RF frequency.

![WinIQSIM - AMIQ - SMIQ setup](/assets/amiq/amiq_smiq_setup.png)

Since the AMIQ has no user interface, the waveform data is provided by some external control
device. This could be a PC that runs R&S WinIQSim software or even a SMIQ because it has the ability 
to drive an AMIQ. You can also create your own waveforms and upload them via floppy disk, GPIB
or an RS-232 interface.

The block diagram of the AMIQ is straightforward and quite similar to the one of my
[HP 33120A function generator](/2023/01/02/HP33120A-Repair-Shutting-Down-the-Eye-of-Sauron.html#a-walk-through-the-block-diagram):

[![AMIQ block diagram](/assets/amiq/amiq_block_diagram.png)](/assets/amiq/amiq_block_diagram.png)
*(Click to enlarge)*

On the left are 2 blocks that are shared:

* a clock synthesizer 
* waveform memory

And then for each channel:

* 14-bit D/A converter
* analog filter
* output section with amplifier/attenuator
* optional differential output driver

The major blocks are surrounded by a large amount of DACs that are used to control everything from
local 10MHz clock oscillator, gain and offset of output signals, clock skew between I and Q signal
and much more.

You could do all of this with a modern SDR setup, except that the specifications of the AMIQ units
are dialed up a notch. Both channels are completely symmetrical to avoid modulation errors at the
source. If there's a need to compensate for small delay differences in, for example, the external 
cables, you can compensate for that by changing the skew between clocks of the output DACs with a 
precision of 10ps. Similarly, the sample frequency can be programmed with 32-bit accuracy.

In addition the main I/Q outputs the front, there are a bunch of secondary input and output signals
available: 

* 10MHz reference input and output
* digital sample clock
* trigger input
* marker output
* external filter loopback output and input
* bit error rate measurement (BER) connector (AMIQ-B1 option)
* differential I/Q output (AMIQ-B2 option)
* parallel interface with digital value of the samples that are sent to the DAC (AMIQ-B3 option)

There are 3 different AMIQ versions:

* 1110.2003.02: 4M samples 
* 1110.2003.03: 4M samples
* 1110.2003.04: 16M samples

I have an AMIQ-04 but it reports itself as an AMIQ-03, which I think is the cause of not being able to
make everything work yet.

# WinIQSim Software

While it is possible to control the AMIQ over RS-232 or GPIB with your own software, you'd have
a hard time matching WinIQSim in terms of features. 

With WinIQSim, you can select one of the popular communication protocols from the late nineties and
early 2000s, fill in digital framing data, apply all kinds of distortions, generate a waveform and
send it to the AMIQ. Some of the supports formats include CDMA2000, IEEE 802.11a WLAN, TD-SCDMA and
more.

But you don't have to use these official protocols, WinIQSim can generate any kind of FSK, QPSK,
QAM or signal.

You need a license for some of the communication protocols. The license is linked to the AMIQ device,
not the PC, but the license check is pretty naive, and while I haven't tried it yet myself, the
EEVblog forum has discussions about how to enable features yourself. My device only came with a license
for IS-95 CDMA. 

# Reviving the Embedded PC

The AMIQ has 2 major subsystems:

* the signal generation PCB
* a standard PC motherboard for general control

It's trivial to open up an AMIQ: after removing the 4 feet in the back with a regular
Philips screwdriver, you can simply slide off the outer case.





# Disassembly

* Remove 4 back feet
* Slide case away
* Cut zip ties
* Unplug 2 flat cables
* Unplug power cable
* Unscrew 4 screws of CPU fan
    * 12V neolec. Screw holes: 33x33mm
* Unplug memory stick: 8x 48LC8M8A2 8MByte per chip -> 64MByte total
* Loosen 4 screws for the motherboard back holding bracket and slide it back
* Unplug speaker cable
* Remove 3 motherboard holding screws
* Remove 6 hex screws for the parallel port, RS232 and X13 connector
    * The motherboard is now loose.
    * It's an [MSI MS5179](https://groups.io/g/Rohde-and-Schwarz/topic/r_s_amiq_generator_need/52310294)
    * [The Retro Web](https://theretroweb.com/motherboards/s/msi-ms-5169-al9)
    * size: 300x
* Lift the motherboard from the left
* Unplug the 2 flat cables on the right
* Unplug right cable with blue and red wires
* Remove heat sink from CPU: push down on the metal clip close to the DRAM slots
    * Remove CPU
* Remove ISA extension slot

Removing HD:
* Remove power cable attachment screw
* Remove 2 screws on aluminum HDD holding plate
* Disconnect cables
* Remove 2 HD attachment screws
* Slide out HD
* Backup HD:
* `sudo apt install gddrescue`
* `ddrescue /dev/<src device> amiq-backup.img`

* Take motherboard out
* Plug in PCI card -> boot screen
* Replace CR2032

* Disk image through http://www.ko4bb.com/getsimple/index.php?id=manuals
* Compact Flash

```
tom@zen:~/projects/tomverbeure.github.io/assets/amiq$ sudo ddrescue -f amiq_hdd.img /dev/sda log
GNU ddrescue 1.23
Press Ctrl-C to interrupt
     ipos:    3253 MB, non-trimmed:        0 B,  current rate:   1003 MB/s
     opos:    3253 MB, non-scraped:        0 B,  average rate:   1084 MB/s
non-tried:        0 B,  bad-sector:        0 B,    error rate:       0 B/s
  rescued:    3253 MB,   bad areas:        0,        run time:          2s
pct rescued:  100.00%, read errors:        0,  remaining time:         n/a
                              time since last successful read:         n/a
Finished                                     
```

Took around 8 minutes even if 'Finished' showed up immediately.



# Capacitors

Caps: they're all aluminum electrolytic radial ones.

* scan front to back - left to right

* 1x 470uF/16V - USB connectors 
* 3x 10uF/25V (tiny)
* 2x 1500uF/10V
* 4x 1000uF/6.3V
* 1x 1000uF/6.3V
* 1x 470uF/16V

* 1x 10uF/25V (tiny)
* 1x 470uF/16V
* 4x 1000uF/6.3V
* 1x 100uF/16V

* 3x 1000uF/6.3V
* 1x 10uF/25V
* 1x 100uF/16V

* 1x 1000uF/10V
* 1x 100uF/16V

* 1x 470uF/16V
* 1x 100uF/16V

* 2x 100uF/16V

* 1x 470uF/16V
* 2x 10uF/25V

* 2x 47uF/25V
* 1x 100uF/16V

Summary:

* 5x 470uF/16V      - 8.3mm diam    - 3.2mm spacing
* 2x 1500uF/10V     - 10.2mm        - 5.5mm
* 10x 1000uF/6.3V   - 8.3mm         - 3.6mm
* 7x 10uF/25V       - 4.2mm         - 2mm
* 7x 100uF/16V      - 5.3mm         - 2mm
* 2x 47uF/25V       - 5.3mm         - 2mm

# Booting up

* Plug in VGA GPU
    * ATI Rage XL 8MB PCI
    * $20.72 on eBay
* [PCI riser card](https://www.mini-box.com/s.nl/it.A/id.289/.f?sc=8&category=1549)
    * $3

* RAM test first
* Use keyboard with PS/2
* DEL key due RAM test to enter BIOS setup screen

# WinIQSim

* Start software
* ARB -> Select Target ARB ... -> AMIQ03
* ARB -> AMIQ -> AMIQ Interface and Transmission Options -> RS 232 -> Default baud rate: 115200
* ARB -> AMIQ -> Remote Control and BERT..

  This will try to access remote. See remote control window.

  * Test and Adjustment
  * Selftest
  * Send command: doesn't work

* quit WinIQSinm
* Putty
  * serial, com3, 115200
  * Terminal: 
    * Local echo: force on
  * Open
  * `*IDN?` -> ...
  
```
*RST
CLOCK 100MHz
ARM
TRIG
SClock EXTFAst   <- switches to external clock input
```

* Calibration of level and offset for I and Q

```
*RST
CAL:ALL?
```

Takes about 30s. Should return 0 if no error.

* Won't work when PCI VGA is not plugged in

  * This is because Primary Display is set to VGA/EGA in "Advanced CMOD Setup"
  * Set to "Absent"
  * After this, VGA card will still work when plugged in, but only in PCI slot
    that is closest to the CPU

* After bootup: "Error: 243, "AMIQ variant check failed;Board-ID 155: Bit:24/24 Vers 05/06"


# References

**Rohde & Schwarz documents**

* [R&S AMIQ Operating Manual](/assets/amiq/AMIQ_OperatingManual_en_08.pdf)
* [R&S AMIQ Service Manual with schematic](/assets/amiq/Rohde_Schwarz_AMIQ_Service_Manual_with_schematics.pdf)
* [R&S AMIQ Overview](/assets/amiq/AMIQ_overview.PDF)
* [R&S AMIQ Datasheet](/assets/amiq/Rohde-Schwarz-AMIQ04-Datasheet.pdf)

* [R&S Floppy Disk Control of the I/Q Modulation Generator AMIQ](/assets/amiq/amiq_floppy_disc_control.pdf)
* [R&S Software WinIQSIM for Calculating I/Q Signals for Modulation Generator R&S AMIQ](/assets/amiq/Software Manual WinIQSIM - ES Documentation.pdf)
* [R&S Creating Test Signals for Bluetooth with AMIQ / WinIQSIM and SMIQ](/assets/amiq/R&S - Creating Test Signals for Bluetooth with AMIQ.pdf)
* [R&S WCDMA Signal Generator Solutions](/assets/amiq/R&S - WCDMA Signal Generator Solutions.pdf)
* [R&S Golden devices: ideal path or detour?](/assets/amiq/R&S Golden devices - ideal path or detour.pdf)
* [R&S Demonstration of BER Test with AMIQ controlled by WinIQSIM](/assets/amiq/R&S - Demonstration of BER Test with AMIQ controlled by WinIQSIM.pdf)

**Other AMIQ content on the web**

* [Lost Manual - Rohde & Schwarz](https://www.lost-manuals.com/en/manufacturer/rohde-schwarz)
* [R&S Groups.io AMIQ repair thread](https://groups.io/g/Rohde-and-Schwarz/topic/r_s_amiq_generator_need/52310294)
* [EEVBlog repair discussion](https://www.eevblog.com/forum/testgear/harddisk-image-for-rs-amiq-generator/)
* [EEVBlog AMIQ license key comment](https://www.eevblog.com/forum/testgear/enabling-options-for-rs-test-equipment/msg3468382/#msg3468382)
* [EEVBlog AMIQ license key comment](https://www.eevblog.com/forum/testgear/enabling-options-for-rs-test-equipment/msg4626139/#msg4626139)
* [EEVBlog AMIQ + SFQ as vector signal generator](https://www.eevblog.com/forum/testgear/rs-smiq-as-a-replacement-for-a-general-signal-generator/msg5400308/#msg5400308)
* [How to get error out of AMIQ?](https://forums.ni.com/t5/UVLabVIEW/How-to-get-errors-form-R-amp-S-AMIQ/td-p/3639064)

* [zw-ix has a blog - Getting an Rohde Schwarz AMIQ up and running](https://zw-ix.nl/blog/2021/02/09/getting-an-rohde-schwarz-amiq-up-and-running/)
* [zw-ix has a blog - Connecting a Rohde Schwarz AMIQ to a SMIQ04](https://zw-ix.nl/blog/2021/02/09/494/)

* [Bosco tweets](https://x.com/BoscoMac/status/1860000781128380629)


**Recapping**

* [Choosing Capacitors to Recap Old Electronics](https://www.youtube.com/watch?app=desktop&v=6PKaj9-1xIs&t=0s)
* [Six Common Mistakes Made When Recapping Vintage Electronics](https://www.youtube.com/watch?v=BeDKwi-GJRI)

**Related content**

* [The Signal Path - Teardown, Repair & Analysis of a Rohde & Schwarz AFQ100A I/Q (ARB) Modulation Generator](https://www.youtube.com/watch?v=6aRZGOcdGUE)
* [Analog Devices - Optimization of EVM Performance in IQ Modulators](https://www.analog.com/en/resources/technical-articles/optimization-of-evm-performance-in-iq-modulators.html)

    Uses an AMIQ in the test setup


