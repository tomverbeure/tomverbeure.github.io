---
layout: post
title: PacMan Cubed - My Second LED Cube
date:   2024-11-02 00:00:00 -1000
categories:
---

* TOC
{:toc}

# Introduction

More than 4 years ago, I created [my first LED cube](/2021/05/16/Pixel-Purse-LED-Cube.html). It was
one big flex, using LED panels that were recovered from an ugly children's toy and controlled
by the FPGA of a reverse engineered Cisco modem. But when I built that cube, I already had 
purchased a bunch of 160mm P2.5 LED panels from AliExpress for what was supposed to be a smaller 
yet higher resolution cube.

With only a month to go before Hackaday Supercon 2023, I didn't have a project lined up to hack on,
so I dug up those panels out of the garage and decided to make another LED cube. This time,
the goal was to get all individual componets ready as quickly as possible so that I could do
the assembly, electronics and software at the conference.

# The Components

You need the following core items for an LED cube:

* the LED panels
* a controller to drive the panels
* a power board for the controller and LEDs
* a mechanical frame to hold everything together

Let's go over these aspects next.

# the LED panels

For my first LED cube, I used 12 rectangular panels with a resolution of 32x16 pixels each,
driven by a standard HUB75 interface. With a resolution of 32x32 pixels per side, you don't
have a lot to work with which is why I used square panels with a resolution of 64x64 pixels
this time around. The LEDs have a pitch of 2.5mm resulting in a square size of 160mm x 160mm,
significantly smaller than the previous cube.

![LED panel P2.5 on AliExpress](/assets/cube2/LED panel P2.5.png)

Back in 2019, the LED panels cost something like $20 a piece, but they are much cheaper
today: on a good day, I'm seeing prices on AliExpress of around $10. They're still equiped
with a HUB75 interface though the pinout may different between different suppliers: rather
than a rigid standard, HUB75 is more of an aspiration of something that resembles one. For
a one-off hobby projects, this doesn't really matter.

There are 64x64 pixel LED panels with a pitch of 2mm. They used to cost signficantly more,
I remember prices of $40 a piece, but those prices have now come down to same price range as
P2.5 panels. If I ever build a third cube, it will use P2 panels. Keep in mind that a size of 
128x128mm will make it harder to squeeze all the cabling and controller board in a tight
space. It wouldn't have worked for the controller board that I'm using in this project.

The HUB75 protocol is the combination of control signals to drive R, G, and B shift registers
that go to the columns of the LED panel, and some address signals to select the row. Most
panels have an input and output connector so that multiple panels can be daisy chained.

But there's a limit to the amount of daisy chaining: on my first LED cube, the limit was
around 8 panels. The limit depends on the rate at which the shift register is operated. To
maintain the same overall refresh rate of the system, the shift register clock speed will
be proportional to the number of pixels that are connect to a single chain. My 64x64
panels have 64x64 pixels instead of 32x16, a factor of 8. This will influence the number
of HUB75 ports on the controller.

# The Colorlight 5A-75B Controller Board

A couple of years ago, [q3k](https://github.com/q3k) spent some time reverse engineering
commercial HUB75 controller cards. Most of of these cards are FPGA based, and since they are
produced at pretty high volume, you need many for large LED panel installations, they are
pretty cheap.

He created the [chubby75 project on GitHub](https://github.com/q3k/chubby75) to which other
people started reverse engineering information. One of the reverse engineered controller 
boards was the Colorlight 5A-75B. I bought one at the time and annotated the PCB:

[![Colorlight 5A-75B annotated PCB](/assets/cube2/cl-5a-75b-v61-front-annotated.jpg)](/assets/cube2/cl-5a-75b-v61-front-annotated.jpg)
*Click to enlarge*

It has a few interesting characteristics:

* it's dirt cheap. They're available on AliExpress for less than $20, including shipping.
* the FPGA is a Lattice ECP5-25 which is fully supported by the Yosys/NextPnR/Project Xray 
  opensource toolchain, which allows me to do all the development on my Macbook.
* it has through-holes exposed for a JTAG connector, right next to the FPGA. Other HUB75
  controller boards require scraping off slik-screen over vias and clumsy soldering work
  to access JTAG signals.
* there are 8 HUB75 connectors which allows my to connect all 6 LED panels without the
  need for daisy chaining.
  
One thing to be aware off: there are multiple PCB versions of this product. Version
[V6.1, V8.0 and V8.2](https://github.com/q3k/chubby75/tree/master/5a-75b) have been successfully
reverse engineered, but who knows if there are other versions out there.

The overall functionality of all versions is the same, but my V6.1 board uses a 381 ball
BGA package of the ECP5-25 while the other known boards are using the 256 ball version.

One major limitation of pretty much all HUB75 controller boards is that they don't have any
general purpose input signals to speak off. When used in their intended configuration, HUB75 
controller boards receive video content over one of their two Gbit Ethernet ports. All HUB75 
pins are output-only, with a uni-directional 75HC245 bus driver between the FPGA and the pins 
to take care of voltage level shifting from 3.3V to 5V.[^1]

It would have been great to be able to attach an IMU, microphone or some USB device to influence
the LED cube content one way or the other but that was not the scope of this project. There
was just not enough time.

# A Custom Power Board

It can take a lot of power to light up 24576 LEDs, so much so that you never actually want
to light them up at the same time. Maximum power consuption for P2.5 panels is on the order
of 700 W/m2, which translates to roughly 18W for a 64x64 P2.5 panel. For a 6-sided cube that
translated to a whopping 108W or 22 Amps on a 5V rail. There's no way you can fit that in a 
small cube, but luckily you don't have to: just make sure to light up all LEDs at maximum
intensity at the same time.

[![Power board 3D](/assets/cube2/power_board_3d.png)](/assets/cube2/power_board_3d.png)
*Click to enlarge*

For the cube, I decided to keep things simple and safe: 18650 battery cells for power, 
**no charging logic**, and off-the-shelve switched power regulators.

I settled on 4 batteries and 2 regulators, each on fed by 2 batteries.

The regulators are LM2596-based DC-DC buck converters: they're dirt cheap on Amazon, a set of
4 will set you back around $7. They can regulator about 3 Amps and step down an input voltage
between 3 to 40V down to 1.5V to 35V. In my case, they're stepping down ~7.5V (2 18650 cells
in series) down to ~5V.

The schematic couldn't be simpler:

[![Power board schematic](/assets/cube2/power_board_schematic.png)](/assets/cube2/power_board_schematic.png)
*Click to enlarge*

I use a bipolar switch to short the connection between J9-J10 and J12-J13.

[![Power board layout](/assets/cube2/power_board_layout.png)](/assets/cube2/power_board_layout.png)
*Click to enlarge*

Lithium batteries freak me out, especially the part where they can catch fire when overcharging.
That's why I didn't add battery charging logic. It's a bit clumsy to remove the batteries from
the board to recharge, but it's really not so bad. 

# Mechanical CAD: FreeCAD Out, Onshape In

When I built my LED ball (blog post still pending...), I spent an extraordinary amount of time
battling the many quirks and crashes of FreeCAD. We're literally talking about 100+ hours of
frustration. 

![LED ball components](/assets/cube2/led_ball_components.jpg)

Admittedly, that project was more complicated than a cube in every possible way, but it left
me wondering whether mechanical CAD was just not for me? Or was it the tool?[^2]

[^2]: FreeCAD is well on its way on gettings major release 1.0. I've been told things are better
      now.

![FreeCAD rendering of ball segments](/assets/cube2/ring_view_1.jpg)

For this project, I didn't have the time to fight a tool ad nauseam, so I looked at alternative
options. I do my development on a mix of Linux, MacOS and sometimes even Windows machines, and
other than FreeCAD there are not many options that support all of these. But one contender is 
[Onshape](https://www.onshape.com/en/): it runs entirely in the browser which is quite amazing
if you think about it. The 
[*Standard Plan*](https://www.onshape.com/en/pricing) 
carries a hefty $1500 per year price tag but there's also a free plan for hobbyists.

Under the free plan, all your designs are publically available but that's OK for me. 

I had heard good things about Onshape, so I gave it a try and, oh boy, what a difference compared
to FreeCAD. I spent an hour or two following some of their online tutorials to get the hang of it,
and then it was off to the races. 

According to my version history, I spent one Sunday playing with Onshape to come up with a first
design, and a week later I sent version 2 to JLCPCB to be 3D printed.

[![LED cube frame in Onshape](/assets/cube2/onshape_led_cube_frame.png)](/assets/cube2/onshape_led_cube_frame.png)
*Click to enlarge*

You can check out the design in Onshape itself by clicking
[this link](https://cad.onshape.com/documents/9c6fc72c1050c20aab7ddb50/w/5c5d9526339ad15dcdb09df8/e/98a4e370f05afd76ca310a5e?renderMode=0&uiState=67273c2f0a199d6efe2b6775).

It would be a bit unfair to compare the number of hours that I spent on FreeCAD against the few hours
on Onshape since some of those initial hours were used to learn the fundamental of mechanical CAD
in general: the use of sketches, parameter design etc.

But all in all I spent maybe 8 hours on Onshape in total. It was intuitive, it just worked, and I
never experienced any crashes. The issue wasn't me, it was the tool after all.[^3]

[^3]: I'm well aware of the topological naming problem of FreeCAD. My issues with FreeCAD were not
      related to it.

# Mechanical Design of the Cube

There are number of constraints that make the frame of an LED cube a bit harded than it seems.

Here are some considerations:

* it needs to look nice
* how to open up one of the 6 sides to access internals
* easy access to charge and/or replace batteries
* how to assemble the thing: screwing parts together, connecting cables
* structural integrity
* cost 

It's fair to say that I failed miserably at most of these points. 

* Instead of 6 or 7 flat pieces that can be assembled together into a cube frame,
  I chose a 3D printed unibody frame. This not only makes it more expensive to print
  but it also blows up the shipping cost.
* I wanted to reuse the tine (0.5mm) screwholes of my LED panels to mount them onto
  the frame. This required a 3D printing process with high precisions. I choose SLS
  which makes things even more expensive. The best part: even then the accuracy wasn't
  good enough to make screw holes align. 
* SLS isn't very stiff. JLCPCB let me know as much before they started the print. But
  this was made worse by have a frame thickness that was too small. Because of this, there
  are gaps between the frame and the panels. It's not a huge deal, once the LEDs are
  lighting up you just don't notice it, but I could have avoided it.
* The batteries are accessible enough, but the JTAG pins of the controller board are
  buried deep inside the cube: if they ever come loose, it's kind of game over and I
  might have to disassemble the cube before I can update the FPGA bitstream ever again.

It's not all bad though: compared to plastic filaments, SLS looks great. I was about
to work about the misaligned screw issue by using... double sided tape. Someone at
Supercon '23 suggested this to me and it works great. It's so much simpler and if anything
the tape is too strong. I'll be using that a lot more for future projects.

![LED panel model](/assets/cube2/LED_panel_model.png)

The design itself and the process to get there was pretty straigforward: I first modeled 
the LED panel itself, including various components along its perimeter to make sure that
the frame wouldn't interfere with them. It can't stress how important it is to do this:
it's so easy to lose track of things that will interfere with each other.

![Single side frame](/assets/cube2/single_side_frame.png)

In the next step, I created a single-side frame in which the panel could fit. You can
see 8 tiny little misguided holes that were intented to used to screw down the panel.
The larger round holes can used to embed magnets so that the top LED panel can be 
removed for inside access.

![Full assembly with center diagonal PCB holder](/assets/cube2/assembly_with_pcb_holder.png)

Those 6 sides are brought together to form the cube frame. A center diagonal divider
is used to provide more structural support and to mount the controller board. I added
additional diagonal ribs perpendicular to the PCB for additional structural support,
but those were a mistake: they make it even harder to reach inside an already cramped 
space and they're also just not necessary: it turns out that square PCBs on 6 sides
of a cube are really good at creating a solid structure.

The center diagonal holds 2 PCBs: on one side the Colorlight 5A-75B, for which dimensions
and mounting hole locations are available from the manufacturer, and a custom power
board PCB on the other. I created the power PCB outline with mountain holes in Onshape
and then imported it into KiCAD for layout. 

![Full assembly with power PCB](/assets/cube2/assembly_with_power_pcb.png)

# Custom Power Board




# References

* [cube2 project on Github](https://github.com/tomverbeure/cube2)

# Footnotes

[^1]:Some enterprising individuals have reworked their boards to convert those ports into bidirectional
     GPIOs, but that's not something I pursued for this project.



